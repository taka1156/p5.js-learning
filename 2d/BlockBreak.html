<!DOCTYPE html><html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="../css/layout.css">
    <title>ブロック崩し</title>
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"></script>
<script src="../js/p5.collide2d.min.js"></script>

<script>
let Blocks = [];//ブロック配列
let Paddle;//パドルオブジェクト
let PlayerBall;//ボールオブジェクト
let Result;//結果 
let count = 0;//壊した数
let Score =0;//得点
let Ballfall = false;//ボールが落ちたかどうか
let Block_sizeX = 90;//block1個当たりのｘサイズ
let Block_sizeY = 20;//block1個当たりのyサイズ
let marginX = 0;//隙間X
let marginY = 0;//隙間Y
const BallSpeed = 4;
const BallDiameter = 18;//ボールの直径
const Row = 8;//行
const Column = 10;//列

class Block{
    constructor(posX,posY){
        this.x = posX;//初期座標X
        this.y = posY;//初期座標Y
        this.block_sizeX = Block_sizeX;//サイズX
        this.block_sizeY = Block_sizeY;//サイズY
        this.R=this.GB=255;//色
        this.hit = false;//当たり判定
    }

    hitCheck(posX, posY, diameter){
        if(this.hit === true)return;
        this.hit = collideRectCircle(this.x, this.y, this.block_sizeX, this.block_sizeY, posX, posY, diameter);
        if(this.hit === true){
            this.x = this.y = this.block_sizeX = this.block_sizeY = 0;
            count++;
        }
    }

    display(){
        if(this.hit === true)return;
        fill(this.R,this.GB,this.GB)
        rect(this.x, this.y, this.block_sizeX, this.block_sizeY);
    }
}

class Ball{
    constructor(){
        this.vecLocation = createVector(width * 0.5 ,height * 0.85);//初期位置
        this.vecVelocity = createVector(BallSpeed,BallSpeed);//速さ
        this.diameter = BallDiameter;//直径
        this.R=this.GB=255;//色
        this.hit = false;//衝突フラグ
    }

    move(posX, posY, sizeX, sizeY){
        if(count===Blocks.length　|| Ballfall === true) return;
        this.hit = collideRectCircle(posX, posY, sizeX, sizeY, this.vecLocation.x, this.vecLocation.y, this.diameter);
        if(this.hit === true){
            this.R=255;
            this.GB = 0;
        }else{
            this.R=this.GB = 255;
        }

        if(this.vecLocation.x < 0 || this.vecLocation.x > width){
            this.vecVelocity.x = this.vecVelocity.x * -1;
        }
        if(this.hit || this.vecLocation.y < 0 ){
            this.vecVelocity.y = this.vecVelocity.y * -1;
            
        }
        if(this.vecLocation.y > height){
            Ballfall = true;
        }
    }

    display(){
        this.vecLocation.add(this.vecVelocity);
        fill(this.R, this.GB, this.GB)
        ellipse(this.vecLocation.x, this.vecLocation.y, this.diameter, this.diameter);
    }
}


class RectPaddle{
    constructor(){
        this.x = width * 0.5;//初期パドル座標X
        this.y = height *0.9;//初期パドル座標Y
        this.Paddle_sizeX = width * 0.12;//サイズX
        this.Paddle_sizeY = height * 0.02;//サイズY
        this.speed = 1;//操作スピード
    }

    move(mouse){
        this.x = Math.max(0, Math.min((mouse * this.speed), width - this.Paddle_sizeX));
    }

    display(){
        fill('gray');
        rect(this.x, this.y, this.Paddle_sizeX, this.Paddle_sizeY);
    }
}

class Message{
    display(sentence,score){
        textAlign(CENTER);
        textSize(width/10);
        fill('red');
        text(sentence, width/2, height/2);

        textAlign(CENTER);
        textSize(width/16);
        fill('red');
        text('Score:' + score, width/2, height/2 + 60 );
    }
}

function setup(){
    createCanvas(windowWidth-10, windowHeight-10);
    Block_sizeX = Math.ceil(width/20);//block1個当たりのｘ座標
    Block_sizeY = Math.ceil(height/50);//block1個当たりのy座標
    marginX = Math.ceil(width/30);
    marginY = Math.ceil(height/50);

    for(let i = 0; i < Row; i++){
        for(let j = 0; j < Column; j++){
            Blocks.push(new Block(Block_sizeX*(j+1)+marginX*(j+1), Block_sizeY*(i+1)+marginY*(i+1)));
        }
    }
    Paddle = new RectPaddle();
    PlayerBall = new Ball();
    Result = new Message();
}

function draw(){
    background(0);
    PlayerBall.move(Paddle.x, Paddle.y, Paddle.Paddle_sizeX, Paddle.Paddle_sizeY);
    PlayerBall.display();

    for(let i = 0; i < Blocks.length; i++){
        if(count===Blocks.length　|| Ballfall === true)break;
        PlayerBall.move(Blocks[i].x, Blocks[i].y, Blocks[i].block_sizeX, Blocks[i].block_sizeY);
        Blocks[i].hitCheck(PlayerBall.vecLocation.x, PlayerBall.vecLocation.y, PlayerBall.diameter);
        Blocks[i].display();
    }

    Score = count * 100;

    if(count === Blocks.length){
        Result.display('Game Clear',Score);
    }
    if(Ballfall === true){
        Result.display('Game Over' ,Score);
    }

    if(mouseIsPressed){
        let X = mouseX;
        Paddle.move(X);
    }
    Paddle.display();
}
</script>
</body>
</html>